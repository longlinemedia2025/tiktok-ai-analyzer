<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Social Analyzer</title>
  <style>
    :root {
      --base-bg: #080808;
    }

    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: var(--base-bg);
      color: #fff;
      overflow-x: hidden;
      min-height: 100vh;
      position: relative;
    }

    /* Canvas Gooey Background */
    #gooey-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      pointer-events: none;
      filter: blur(60px) saturate(160%) brightness(1.4);
    }

    /* Container */
    .container {
      max-width: 800px;
      margin: 100px auto;
      padding: 40px;
      background: rgba(20, 20, 20, 0.84);
      border-radius: 20px;
      box-shadow: 0 0 30px rgba(255,255,255,0.04);
      text-align: center;
      backdrop-filter: blur(8px);
      position: relative;
      z-index: 2;
    }

    h1 { font-size: 2.2rem; margin-bottom: 20px; }

    select, input[type="file"], button {
      margin: 10px 0;
      padding: 10px;
      border-radius: 10px;
      border: none;
      font-size: 1rem;
      width: 100%;
      box-sizing: border-box;
    }

    select, input[type="file"] { background: #fff; color: #000; }
    button {
      background: #ff0050;
      color: #fff;
      cursor: pointer;
      transition: 0.3s;
      font-weight: 800;
      border-radius: 12px;
      padding: 12px;
    }
    button:hover { opacity: 0.92; transform: translateY(-2px); }

    #loading-bar {
      height: 8px;
      width: 0%;
      background: #ff0050;
      border-radius: 5px;
      margin-top: 15px;
      transition: width 0.18s ease, background 0.3s ease;
    }

    #ai-results {
      margin-top: 30px;
      text-align: left;
      background: rgba(255,255,255,0.03);
      padding: 20px;
      border-radius: 10px;
      display: none;
      color: #fff;
    }

    #ai-results h3 { margin-top: 0; }

    .file-meta { color: #cfcfcf; font-size: 0.95rem; margin-top: 6px; }

    @media (max-width: 768px) {
      .container {
        width: 90%;
        margin: 60px auto;
        padding: 25px;
      }
      h1 { font-size: 1.8rem; }
    }
  </style>
</head>

<body data-platform="tiktok">
  <canvas id="gooey-canvas"></canvas>

  <div class="container" role="main">
    <h1>AI Social Analyzer</h1>

    <select id="platform" aria-label="Select platform">
      <option value="tiktok" selected>TikTok</option>
      <option value="youtube">YouTube</option>
      <option value="instagram">Instagram</option>
    </select>

    <h3>Upload a Video</h3>
    <input type="file" id="videoUpload" accept="video/*"/>
    <div id="video-meta" class="file-meta"></div>

    <h3>Upload CSV for Analysis</h3>
    <input type="file" id="csvUpload" accept=".csv"/>
    <div id="csv-meta" class="file-meta"></div>

    <button id="analyzeBtn">Analyze</button>
    <div id="loading-bar" aria-hidden="true"></div>

    <div id="ai-results" aria-live="polite">
      <h3>AI Results</h3>
      <pre id="full-result" style="white-space:pre-wrap; background:transparent; border:none; color:inherit; padding:0; margin:0;"></pre>
      <div style="margin-top:12px;">
        <p><strong>Caption:</strong> <span id="caption">Waiting...</span></p>
        <p><strong>Hashtags:</strong> <span id="hashtags">Waiting...</span></p>
        <p><strong>Tags:</strong> <span id="tags">Waiting...</span></p>
        <p><strong>Score:</strong> <span id="score">Waiting...</span></p>
      </div>
    </div>
  </div>

  <script>
    /* Canvas Gooey Background */
    const canvas = document.getElementById("gooey-canvas");
    const ctx = canvas.getContext("2d");
    let width, height, blobs = [];

    const platformColors = {
      tiktok: ['#ff0050', '#00f2ea', '#ff66c4'],
      youtube: ['#ff0000', '#ff6347', '#ff7f50'],
      instagram: ['#e1306c', '#f77737', '#ffdc80']
    };

    function resizeCanvas() {
      width = canvas.width = window.innerWidth * devicePixelRatio;
      height = canvas.height = window.innerHeight * devicePixelRatio;
      ctx.scale(devicePixelRatio, devicePixelRatio);
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function initBlobs() {
      blobs = [];
      const platform = document.getElementById("platform")?.value || "tiktok";
      const colors = platformColors[platform];
      for (let i = 0; i < 8; i++) {
        blobs.push({
          x: Math.random() * width,
          y: Math.random() * height,
          r: 100 + Math.random() * 80,
          dx: (Math.random() - 0.5) * 1.1,
          dy: (Math.random() - 0.5) * 1.1,
          color: colors[i % colors.length],
          pulseOffset: Math.random() * Math.PI * 2
        });
      }
    }

    function animateBlobs(t) {
      ctx.clearRect(0, 0, width, height);
      ctx.save();
      ctx.globalCompositeOperation = "lighter";
      blobs.forEach(b => {
        b.x += b.dx;
        b.y += b.dy;
        if (b.x < -200) b.x = width + 200;
        if (b.x > width + 200) b.x = -200;
        if (b.y < -200) b.y = height + 200;
        if (b.y > height + 200) b.y = -200;
        const pulse = 1 + Math.sin(t / 700 + b.pulseOffset) * 0.06;
        const radius = b.r * pulse;
        const gradient = ctx.createRadialGradient(b.x, b.y, 0, b.x, b.y, radius);
        gradient.addColorStop(0, b.color + "aa");
        gradient.addColorStop(1, b.color + "00");
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(b.x, b.y, radius, 0, Math.PI * 2);
        ctx.fill();
      });
      ctx.restore();
      requestAnimationFrame(animateBlobs);
    }

    document.getElementById("platform")?.addEventListener("change", initBlobs);

    initBlobs();
    requestAnimationFrame(animateBlobs);

    /* UI Logic */
    const loadingBar = document.getElementById('loading-bar');
    const platformSelect = document.getElementById('platform');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const aiResults = document.getElementById('ai-results');
    const fullResult = document.getElementById('full-result');
    const captionEl = document.getElementById('caption');
    const hashtagsEl = document.getElementById('hashtags');
    const tagsEl = document.getElementById('tags');
    const scoreEl = document.getElementById('score');
    const videoUpload = document.getElementById('videoUpload');
    const csvUpload = document.getElementById('csvUpload');
    const videoMeta = document.getElementById('video-meta');
    const csvMeta = document.getElementById('csv-meta');
    let progress = 0;

    const platformThemes = platformColors;
    function updateColors() {
      const platform = platformSelect.value;
      const palette = platformThemes[platform] || platformThemes['tiktok'];
      analyzeBtn.style.background = palette[0];
      loadingBar.style.background = palette[0];
    }

    videoUpload.addEventListener('change', ()=> {
      if (videoUpload.files.length) {
        const f = videoUpload.files[0];
        videoMeta.textContent = `Uploaded: ${f.name} • ${new Date().toLocaleString()}`;
      } else { videoMeta.textContent = ''; }
    });
    csvUpload.addEventListener('change', ()=> {
      if (csvUpload.files.length) {
        const f = csvUpload.files[0];
        csvMeta.textContent = `Uploaded: ${f.name} • ${new Date().toLocaleString()}`;
      } else { csvMeta.textContent = ''; }
    });

    platformSelect.addEventListener('change', updateColors);
    updateColors();

    analyzeBtn.addEventListener('click', async () => {
      const videoFile = videoUpload.files[0];
      const csvFile = csvUpload.files[0];
      const platform = platformSelect.value;

      if (!videoFile) { alert("Please upload a video first!"); return; }

      progress = 0;
      aiResults.style.display = "none";
      fullResult.textContent = "";
      captionEl.innerText = "Waiting...";
      hashtagsEl.innerText = "Waiting...";
      tagsEl.innerText = "Waiting...";
      scoreEl.innerText = "Waiting...";
      loadingBar.style.width = "0%";

      const progressInterval = setInterval(() => {
        progress += Math.random() * 6;
        if (progress >= 92) progress = 92;
        loadingBar.style.width = progress + "%";
      }, 180);

      const fd = new FormData();
      fd.append('platform', platform);
      fd.append('video', videoFile);
      if (csvFile) fd.append('csv', csvFile);

      try {
        const resp = await fetch('/analyze', { method: 'POST', body: fd });
        const data = await resp.json();
        clearInterval(progressInterval);
        loadingBar.style.width = "100%";
        if (data.error) { alert("Error: " + data.error); return; }

        const resultText = data.result || "";
        fullResult.textContent = resultText;
        const s = data.structured || {};
        captionEl.innerText = s.caption || "N/A";
        hashtagsEl.innerText = s.hashtags || s.tags || "Not detected";
        tagsEl.innerText = s.tags || "N/A";
        scoreEl.innerText = (s.optimization_score !== undefined) ? s.optimization_score : "N/A";

        aiResults.style.display = "block";
        setTimeout(()=> { loadingBar.style.width = "0%"; }, 800);
      } catch (err) {
        clearInterval(progressInterval);
        loadingBar.style.width = "0%";
        alert("Server error: " + (err.message || err));
        console.error(err);
      }
    });
  </script>
</body>
</html>
