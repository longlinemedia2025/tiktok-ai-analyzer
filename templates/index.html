<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TikTok & YouTube Viral Optimizer</title>
  <style>
    body {
      font-family: "Inter", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(-45deg, #0b0b0b, #141414, #1a1a1a, #0b0b0b);
      background-size: 400% 400%;
      animation: gradientFlow 15s ease infinite;
      color: #f5f5f5;
      text-align: center;
      padding: 40px;
      margin: 0;
      transition: background 1.2s ease-in-out, color 0.6s;
    }

    @keyframes gradientFlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* TikTok animated gradient */
    body.tiktok-mode {
      background: linear-gradient(-45deg, #0b0b0b, #111, #00f2ea, #ff0050);
      background-size: 400% 400%;
      animation: gradientFlow 10s ease infinite;
    }

    /* YouTube animated gradient */
    body.youtube-mode {
      background: linear-gradient(-45deg, #0b0b0b, #111, #ff0000, #ff4d00);
      background-size: 400% 400%;
      animation: gradientFlow 10s ease infinite;
    }

    #logo {
      width: 110px;
      margin-bottom: 20px;
      filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.3));
      transition: filter 0.5s ease-in-out;
    }

    h1 {
      font-size: 2.2rem;
      margin-bottom: 1.5rem;
      color: #00f2ea; /* TikTok cyan default */
      text-shadow: 0 0 8px rgba(0, 242, 234, 0.6);
      transition: color 0.6s, text-shadow 0.6s;
    }

    .upload-container {
      border: 2px dashed #333;
      border-radius: 16px;
      padding: 30px;
      margin: 20px auto;
      width: 80%;
      max-width: 600px;
      background-color: rgba(20, 20, 20, 0.9);
      transition: all 0.3s ease-in-out;
    }

    .upload-container:hover {
      border-color: #00f2ea;
      background-color: #1c1c1c;
    }

    input[type="file"] {
      display: none;
    }

    label {
      cursor: pointer;
      color: #00f2ea;
      font-weight: bold;
      display: block;
      margin-top: 10px;
      transition: 0.3s;
    }

    label:hover {
      color: #26d9ff;
    }

    button {
      background-color: #00f2ea;
      border: none;
      color: #fff;
      padding: 14px 28px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1rem;
      transition: 0.3s;
      margin-top: 25px;
      font-weight: bold;
      box-shadow: 0 0 10px rgba(0, 242, 234, 0.4);
    }

    button:hover {
      background-color: #0097a7;
      box-shadow: 0 0 15px rgba(0, 242, 234, 0.6);
    }

    select {
      background-color: #141414;
      color: #fff;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 1rem;
      margin-bottom: 15px;
      outline: none;
    }

    select:hover {
      border-color: #00f2ea;
    }

    #results {
      margin-top: 30px;
      white-space: pre-wrap;
      background-color: #141414;
      border-radius: 14px;
      padding: 25px;
      width: 85%;
      max-width: 780px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
      line-height: 1.7;
      box-shadow: 0 0 20px rgba(0, 242, 234, 0.15);
    }

    .detected-section {
      margin-top: 20px;
      text-align: left;
      width: 85%;
      max-width: 750px;
      margin-left: auto;
      margin-right: auto;
      background-color: #1a1a1a;
      border-radius: 12px;
      padding: 20px;
      opacity: 0;
      transition: opacity 0.8s ease-in-out;
      box-shadow: 0 0 15px rgba(0, 242, 234, 0.15);
    }

    .detected-section.visible {
      opacity: 1;
    }

    .detected-section h3 {
      color: #00f2ea;
      margin-bottom: 10px;
    }

    .loader {
      display: none;
      margin: 30px auto;
      text-align: center;
    }

    .dots {
      margin: 10px auto;
    }

    .dot {
      height: 12px;
      width: 12px;
      margin: 0 4px;
      background-color: #00f2ea;
      border-radius: 50%;
      display: inline-block;
      animation: pulse 1.4s infinite ease-in-out both;
    }

    .dot:nth-child(1) { animation-delay: -0.32s; }
    .dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes pulse {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    #loader-text {
      color: #aaa;
      font-style: italic;
      margin-top: 10px;
      font-size: 0.95rem;
      min-height: 20px;
    }

    #reset-btn {
      display: none;
      margin-top: 25px;
      background-color: #333;
    }

    #reset-btn:hover {
      background-color: #444;
    }

    /* YouTube mode overrides */
    body.youtube-mode h1 {
      color: #ff0000;
      text-shadow: 0 0 8px rgba(255, 0, 0, 0.6);
    }

    body.youtube-mode .upload-container:hover {
      border-color: #ff0000;
    }

    body.youtube-mode label {
      color: #ff0000;
    }

    body.youtube-mode label:hover {
      color: #ff4d4d;
    }

    body.youtube-mode button {
      background-color: #ff0000;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.4);
    }

    body.youtube-mode button:hover {
      background-color: #c40000;
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
    }

    body.youtube-mode #results,
    body.youtube-mode .detected-section {
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.15);
    }

    body.youtube-mode .detected-section h3 {
      color: #ff0000;
    }

    body.youtube-mode .dot {
      background-color: #ff0000;
    }

    /* ---------- New additions (progress bar, timing, live-feed) ---------- */
    .progress-wrap {
      width: 72%;
      max-width: 720px;
      margin: 18px auto 0 auto;
      display: none; /* show only while analyzing */
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 8px;
    }

    .progress-bar {
      width: 100%;
      height: 12px;
      border-radius: 999px;
      overflow: hidden;
      position: relative;
      background: rgba(255,255,255,0.04);
      box-shadow: 0 8px 24px rgba(0,0,0,0.6), inset 0 -6px 18px rgba(0,0,0,0.25);
      backdrop-filter: blur(4px);
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      transition: width 0.5s cubic-bezier(.2,.9,.2,1);
      position: relative;
      overflow: hidden;
    }

    .progress-fill::before{
      content:'';
      position:absolute;
      top:-40%;
      left:-50%;
      width:200%;
      height:200%;
      background: linear-gradient(120deg,
        rgba(0,242,234,0.95) 0%,
        rgba(255,0,80,0.9) 40%,
        rgba(255,255,255,0.85) 55%,
        rgba(255,0,80,0.9) 70%,
        rgba(0,242,234,0.95) 100%);
      transform: translateX(var(--shift, 0%)) rotate(-6deg);
      filter: blur(8px) saturate(1.1);
      animation: shimmer 2.8s linear infinite;
      mix-blend-mode: screen;
      opacity: 0.95;
    }

    @keyframes shimmer {
      0% { transform: translateX(-40%) rotate(-6deg); }
      100% { transform: translateX(40%) rotate(-6deg); }
    }

    .progress-fill::after{
      content:'';
      position:absolute;
      left:0;
      top:0;
      height:100%;
      width:100%;
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.01));
      mix-blend-mode: overlay;
      pointer-events:none;
    }

    .progress-reflection {
      width: 72%;
      max-width:720px;
      height: 18px;
      margin: -8px auto 0 auto;
      filter: blur(16px) saturate(1.1);
      opacity: 0.18;
      border-radius: 999px;
      pointer-events:none;
      display:none;
    }

    .live-feed {
      margin-top: 8px;
      color: #cfcfcf;
      font-size: 0.95rem;
      min-height: 20px;
      text-align:center;
    }

    .uploaded-ts { font-size: 0.9rem; color: #bdbdbd; margin-top: 6px; }

    /* platform-specific fills (overridden by mode) */
    body.youtube-mode .progress-fill::before {
      background: linear-gradient(120deg, #ff0000 0%, #ffffff 45%, #ff4d00 80%);
    }
    body.tiktok-mode .progress-fill::before {
      background: linear-gradient(120deg, #00f2ea 0%, #ff0050 45%, #ffffff 60%);
    }
    /* ---------------- end additions ---------------- */
  </style>
</head>
<body class="tiktok-mode">
  <img src="/static/Longlinemedialogotransparent.png" alt="LongLine Media Logo" id="logo">
  <h1>🎬 TikTok & YouTube Viral Optimizer</h1>

  <div>
    <label for="platform">Select Platform:</label><br />
    <select id="platform">
      <option value="TikTok">TikTok</option>
      <option value="YouTube">YouTube</option>
    </select>
  </div>

  <div class="upload-container" id="video-dropzone">
    <p>🎬 Drag and drop your video here or click to upload</p>
    <input type="file" id="video" accept="video/*" />
    <label for="video">Choose a video</label>
    <p id="video-filename"></p>
    <div class="uploaded-ts" id="video-ts"></div>
  </div>

  <div class="upload-container" id="csv-dropzone">
    <p>📄 Upload your CSV data (optional)</p>
    <input type="file" id="csv" accept=".csv" />
    <label for="csv">Choose a CSV</label>
    <p id="csv-filename"></p>
    <div class="uploaded-ts" id="csv-ts"></div>
  </div>

  <button id="analyze-btn">Analyze</button>

  <!-- Centered progress, reflection and live-feed (hidden until analyzing) -->
  <div class="progress-wrap" id="progress-wrap">
    <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100">
      <div class="progress-fill" id="progress-fill" style="--shift:0%"></div>
    </div>
    <div class="progress-reflection" id="progress-reflection"></div>
    <div class="live-feed" id="live-feed"></div>
  </div>

  <div class="loader" id="loader">
    <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    <p id="loader-text">Initializing AI analysis...</p>
  </div>

  <div id="detected" class="detected-section">
    <h3>🤖 Auto-Detected Video Attributes</h3>
    <p><strong>Niche:</strong> <span id="niche"></span></p>
    <p><strong>Tone:</strong> <span id="tone"></span></p>
    <p><strong>Keywords:</strong> <span id="keywords"></span></p>
  </div>

  <div id="results"></div>
  <button id="reset-btn">🔄 New Analysis</button>

  <script>
    const videoInput = document.getElementById("video");
    const csvInput = document.getElementById("csv");
    const videoFilename = document.getElementById("video-filename");
    const csvFilename = document.getElementById("csv-filename");
    const videoTs = document.getElementById("video-ts");
    const csvTs = document.getElementById("csv-ts");
    const analyzeBtn = document.getElementById("analyze-btn");
    const resetBtn = document.getElementById("reset-btn");
    const resultsDiv = document.getElementById("results");
    const detectedDiv = document.getElementById("detected");
    const nicheEl = document.getElementById("niche");
    const toneEl = document.getElementById("tone");
    const keywordsEl = document.getElementById("keywords");
    const platformSelect = document.getElementById("platform");
    const loader = document.getElementById("loader");
    const loaderText = document.getElementById("loader-text");
    const logo = document.getElementById("logo");

    const progressWrap = document.getElementById("progress-wrap");
    const progressFill = document.getElementById("progress-fill");
    const progressReflection = document.getElementById("progress-reflection");
    const liveFeed = document.getElementById("live-feed");

    let progressInterval, feedInterval;

    // Live feed messages while analyzing
    const liveMessages = [
      "🔍 Extracting video metadata...",
      "🎨 Detecting tone and visuals...",
      "🔊 Processing audio & beats...",
      "🧠 Analyzing engagement potential...",
      "📊 Comparing with viral examples...",
      "💡 Generating captions, tags & insights..."
    ];

    function setUploadedFileUI(inputEl, filenameEl, tsEl) {
      if (inputEl.files && inputEl.files[0]) {
        filenameEl.textContent = `Uploaded: ${inputEl.files[0].name}`;
        const now = new Date();
        tsEl.textContent = `Uploaded at ${now.toLocaleString()}`;
      }
    }

    videoInput.addEventListener("change", () => setUploadedFileUI(videoInput, videoFilename, videoTs));
    csvInput.addEventListener("change", () => setUploadedFileUI(csvInput, csvFilename, csvTs));

    function resetAll() {
      resultsDiv.textContent = "";
      videoFilename.textContent = "";
      csvFilename.textContent = "";
      videoTs.textContent = "";
      csvTs.textContent = "";
      detectedDiv.classList.remove("visible");
      detectedDiv.style.display = "none";
      loader.style.display = "none";
      analyzeBtn.style.display = "inline-block";
      resetBtn.style.display = "none";
      videoInput.value = "";
      csvInput.value = "";
      // reset progress
      progressFill.style.width = "0%";
      progressWrap.style.display = "none";
      progressReflection.style.display = "none";
      liveFeed.textContent = "";
      clearIntervals();
    }

    function clearIntervals() {
      if (progressInterval) { clearInterval(progressInterval); progressInterval = null; }
      if (feedInterval) { clearInterval(feedInterval); feedInterval = null; }
    }

    platformSelect.addEventListener("change", () => {
      document.body.classList.toggle("youtube-mode", platformSelect.value === "YouTube");
      document.body.classList.toggle("tiktok-mode", platformSelect.value === "TikTok");
    });

    // simulate progress & cycle live feed
    function startProgressSimulation() {
      progressWrap.style.display = "flex";
      progressReflection.style.display = "block";
      progressFill.style.width = "4%";
      let progress = 4;
      progressInterval = setInterval(() => {
        // random small increments until 92%
        const inc = Math.random() * 8 + 3; // 3-11
        progress = Math.min(92, progress + inc);
        progressFill.style.width = progress + "%";
        // slowly move shimmer
        const shift = (Math.random() * 60) - 30;
        progressFill.style.setProperty('--shift', shift + '%');
      }, 900);

      let idx = 0;
      liveFeed.textContent = liveMessages[idx];
      feedInterval = setInterval(() => {
        idx = (idx + 1) % liveMessages.length;
        liveFeed.textContent = liveMessages[idx];
      }, 1600);
    }

    function stopProgressSimulation() {
      clearIntervals();
      progressFill.style.width = "100%";
      liveFeed.textContent = "✅ Finalizing results...";
      setTimeout(() => {
        progressWrap.style.display = "none";
        progressReflection.style.display = "none";
        liveFeed.textContent = "";
      }, 700);
    }

    analyzeBtn.addEventListener("click", async () => {
      const videoFile = videoInput.files[0];
      const csvFile = csvInput.files[0];
      const platform = platformSelect.value;

      if (!videoFile) return alert("Please upload a video file first.");

      // UI changes
      resultsDiv.textContent = `🎥 Running ${platform} Viral Optimizer...\n\n🤖 Generating AI-powered analysis...`;
      detectedDiv.classList.remove("visible");
      detectedDiv.style.display = "none";
      loader.style.display = "block";
      loaderText.textContent = "Initializing AI analysis...";

      startProgressSimulation();
      analyzeBtn.disabled = true;

      const formData = new FormData();
      formData.append("video", videoFile);
      formData.append("platform", platform);
      if (csvFile) formData.append("csv", csvFile);

      try {
        const response = await fetch("/analyze", { method: "POST", body: formData });
        const data = await response.json();

        stopProgressSimulation();
        loader.style.display = "none";
        analyzeBtn.disabled = false;

        if (data.error) {
          resultsDiv.textContent = "❌ Error: " + data.error;
          return;
        }

        const resultText = data.result || data.ai_results || JSON.stringify(data, null, 2);
        resultsDiv.textContent = resultText;

        // try to extract detection lines from text (robust to a few formats)
        const nicheMatch = resultText.match(/Detected Niche:\s*([^\n\r]+)/) || resultText.match(/Niche:\s*\*\*(.+?)\*\*/);
        const toneMatch = resultText.match(/Tone:\s*([^\n\r]+)/);
        const keywordsMatch = resultText.match(/Keywords?:\s*([^\n\r]+)/);

        nicheEl.textContent = nicheMatch ? (nicheMatch[1] || nicheMatch[0]).trim() : "N/A";
        toneEl.textContent = toneMatch ? toneMatch[1].trim() : "Neutral/Mixed";
        keywordsEl.textContent = keywordsMatch ? keywordsMatch[1].trim() : "None detected";

        detectedDiv.style.display = "block";
        setTimeout(() => detectedDiv.classList.add("visible"), 100);
        resetBtn.style.display = "inline-block";

      } catch (err) {
        stopProgressSimulation();
        loader.style.display = "none";
        analyzeBtn.disabled = false;
        resultsDiv.textContent = "❌ Error processing your request.";
        console.error(err);
      }
    });

    resetBtn.addEventListener("click", resetAll);

    // Simple drag & drop support (keeps your original UX)
    const videoZone = document.getElementById("video-dropzone");
    videoZone.addEventListener("dragover", e => { e.preventDefault(); videoZone.style.borderColor = "#66ffd8"; });
    videoZone.addEventListener("dragleave", e => { videoZone.style.borderColor = "#333"; });
    videoZone.addEventListener("drop", e => {
      e.preventDefault();
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) {
        videoInput.files = e.dataTransfer.files;
        setUploadedFileUI(videoInput, videoFilename, videoTs);
      }
      videoZone.style.borderColor = "#333";
    });

    const csvZone = document.getElementById("csv-dropzone");
    csvZone.addEventListener("dragover", e => { e.preventDefault(); csvZone.style.borderColor = "#66ffd8"; });
    csvZone.addEventListener("dragleave", e => { csvZone.style.borderColor = "#333"; });
    csvZone.addEventListener("drop", e => {
      e.preventDefault();
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) {
        csvInput.files = e.dataTransfer.files;
        setUploadedFileUI(csvInput, csvFilename, csvTs);
      }
      csvZone.style.borderColor = "#333";
    });
  </script>
</body>
</html>
