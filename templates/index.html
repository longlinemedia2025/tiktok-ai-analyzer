<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TikTok Viral Optimizer</title>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #0e0e0e;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px;
    }
    h1 {
      color: #00e0ff;
    }
    .upload-area {
      border: 2px dashed #555;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      width: 80%;
      max-width: 600px;
      margin-top: 20px;
    }
    #loadingBarContainer {
      width: 80%;
      max-width: 600px;
      height: 18px;
      border-radius: 10px;
      background-color: #333;
      margin-top: 25px;
      overflow: hidden;
      display: none;
    }
    #loadingBar {
      height: 100%;
      width: 0%;
      background-color: #00e0ff;
      transition: width 0.4s ease;
    }
    #statusFeed {
      margin-top: 12px;
      font-size: 14px;
      color: #aaa;
      text-align: center;
      display: none;
    }
    select, input[type="file"], button {
      margin-top: 15px;
      padding: 10px;
      border-radius: 6px;
      border: none;
      font-size: 15px;
    }
    button {
      background: #00e0ff;
      color: #000;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: #00aacc;
    }
    pre {
      text-align: left;
      background: #1b1b1b;
      padding: 20px;
      border-radius: 10px;
      max-width: 800px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <h1>🎬 TikTok Viral Optimizer</h1>

  <div class="upload-area" id="uploadArea">
    <form id="uploadForm">
      <label>Choose Platform:</label><br />
      <select name="platform" id="platformSelect">
        <option value="TikTok">TikTok</option>
        <option value="Instagram">Instagram</option>
        <option value="YouTube">YouTube</option>
        <option value="Facebook">Facebook</option>
      </select><br /><br />
      <label>Upload Your Video:</label><br />
      <input type="file" id="videoFile" name="video" accept="video/*" required /><br /><br />

      <!-- CSV upload (kept exactly as before) -->
      <label>Optional CSV Upload:</label><br />
      <input type="file" id="csvFile" name="csv" accept=".csv" /><br /><br />

      <button type="submit">Run Analysis</button>
    </form>
  </div>

  <!-- Loading bar and live status -->
  <div id="loadingBarContainer">
    <div id="loadingBar"></div>
  </div>
  <div id="statusFeed">Starting analysis...</div>

  <!-- Results -->
  <h2 id="resultsHeader" style="display:none;">AI Results</h2>
  <pre id="results"></pre>

  <script>
    const form = document.getElementById("uploadForm");
    const videoFile = document.getElementById("videoFile");
    const results = document.getElementById("results");
    const resultsHeader = document.getElementById("resultsHeader");
    const loadingBarContainer = document.getElementById("loadingBarContainer");
    const loadingBar = document.getElementById("loadingBar");
    const statusFeed = document.getElementById("statusFeed");
    const platformSelect = document.getElementById("platformSelect");

    const platformColors = {
      TikTok: "#ff0050",
      Instagram: "#e1306c",
      YouTube: "#ff0000",
      Facebook: "#1877f2",
    };

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const file = videoFile.files[0];
      if (!file) {
        alert("Please upload a video first!");
        return;
      }

      // Prepare UI
      resultsHeader.style.display = "none";
      results.textContent = "";
      loadingBarContainer.style.display = "block";
      statusFeed.style.display = "block";
      loadingBar.style.width = "0%";
      loadingBar.style.backgroundColor =
        platformColors[platformSelect.value] || "#00e0ff";

      // Simulate AI activity feed
      const messages = [
        "Uploading video...",
        "Analyzing visuals and metadata...",
        "Detecting niche and patterns...",
        "Fetching viral comparisons...",
        "Generating captions, hashtags, and insights...",
        "Finalizing output..."
      ];
      let i = 0;
      const interval = setInterval(() => {
        if (i < messages.length) {
          statusFeed.textContent = messages[i];
          loadingBar.style.width = `${(i / messages.length) * 100}%`;
          i++;
        } else {
          clearInterval(interval);
        }
      }, 1000);

      const formData = new FormData(form);

      try {
        const response = await fetch("/analyze", {
          method: "POST",
          body: formData,
        });

        clearInterval(interval);
        loadingBar.style.width = "100%";
        statusFeed.textContent = "AI analysis complete!";

        if (!response.ok) throw new Error("Analysis failed.");
        const data = await response.json();

        resultsHeader.style.display = "block";
        results.textContent = data.results || "No analysis results received.";
      } catch (err) {
        console.error(err);
        resultsHeader.style.display = "block";
        results.textContent =
          "⚠️ Error: Could not complete the analysis. Please check your Flask logs.";
        statusFeed.textContent = "Analysis failed.";
        loadingBar.style.backgroundColor = "#ff4444";
      }
    });
  </script>
</body>
</html>
